<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/acb8172d7678da98.css" as="style"/><link rel="stylesheet" href="/_next/static/css/acb8172d7678da98.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/verify-token-e7fd6dbb5915b241.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->24<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/verify-token" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Verify Token</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">Assume we have a Single Page Application (SPA) calling our <u>GenerateToken</u> API on behalf of the user with the username and password provided by the user himself. Once the API authenticates and issues the token, the SPA will store the token somewhere to send it back in subsequent requests as a Bearer token in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authorization</mark> header in the format <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Bearer &lt;TOKEN&gt;</mark>.</p><p class="Paragraph_paragraph__90U8D">Bearer token is a security token similar to cash, whoever possess the token can use it in any way the token is intended for. Using a bearer token does not require a bearer to prove the possession of the token. So it must be stored securely and transferred over a secure network.</p></section><section><h3 class="fw-light mt-5 mb-2">Find user by token</h3><p class="Paragraph_paragraph__90U8D">In order to verify the token, we need to identify the user associated with the token as well as ensure the token is not expired. So we will find the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> by <em>token</em> and <em>tokenExpiryTime</em> greater than the current time using standard Spring Data JPA method in AppUserRepository.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/verify-token/src/main/java/com/facadecode/spring/security/repo/AppUserRepository.java" target="_blank">AppUserRepository.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppUserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;AppUser, Long&gt; {
    <span class="hljs-comment">// Other methods omitted for brevity</span>
    Optional&lt;AppUser&gt; <span class="hljs-title function_">findByTokenAndTokenExpiryTimeGreaterThan</span><span class="hljs-params">(String token, Date currentDate)</span>;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Similar to <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">loadUserByUsername()</mark> we will implement a method in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DbUserDetailsService</mark> to call the above repository method and return the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> object mapped from the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record. By passing current time along with token we ensure that the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record returned is not only matching the <em>token</em> but also it&#x27;s <em>tokenExpiryTime</em> is always greater than the current time.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/verify-token/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailsService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByToken</span><span class="hljs-params">(String token)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException {
    <span class="hljs-type">AppUser</span> <span class="hljs-variable">appUser</span> <span class="hljs-operator">=</span> appUserRepository.findByTokenAndTokenExpiryTimeGreaterThan(token, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())
            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-string">&quot;Provided token is either expired or not found&quot;</span>));

    <span class="hljs-keyword">return</span> User.builder()
        .username(appUser.getUsername())
        .password(appUser.getPassword())
        .authorities(<span class="hljs-built_in">this</span>.getPermissions(appUser.getRoles()))
        .build();
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">TokenVerificationFilter</h3><p class="Paragraph_paragraph__90U8D">Before the request reaches the endpoint we have to intercept the request and authenticate the user by the token extracted from the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authorization</mark> header. This can be done using standard Spring filter extending <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">OncePerRequestFilter</mark>. Let&#x27;s create the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">TokenVerficiationFilter</mark> component in order to perform the steps mentioned in the comments.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/verify-token/src/main/java/com/facadecode/spring/security/filters/TokenVerificationFilter.java" target="_blank">TokenVerficationFilter.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Component</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenVerificationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> {
    <span class="hljs-meta">@Override</span>  
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        <span class="hljs-comment">// Extract the token from the Authorization header</span>
        <span class="hljs-comment">// Identify the user by token using the above loadUserByToken() service method</span>
        <span class="hljs-comment">// Create Authentication object as authenticated principal</span>
        <span class="hljs-comment">// Set Authentication in SecurityContext</span>
        filterChain.doFilter(request, response);
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">The format of the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authorization</mark> header value will be <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Bearer &lt;TOKEN&gt;</mark>, so we have to remove the prefix <em>Bearer</em> (with a whitespace) to get only the token value. We will use the token to find the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> object from the above <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">loadUserByToken()</mark> service method.</p><p class="Paragraph_paragraph__90U8D">Remember we have used <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UsernamePasswordAuthenticationToken</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">generateToken()</mark> service in order to create <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as an authentication request using <em>username</em> and <em>password</em>. Here we are using the same to create <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as an authenticated principal using <em>username</em> and his <em>authorities</em> retrieved from the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> object. We will then set it in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark> by ourselves to make it available through out the request in order to authorize the user at various layers.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/verify-token/src/main/java/com/facadecode/spring/security/filters/TokenVerificationFilter.java" target="_blank">TokenVerificationFilter.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenVerificationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> {
    <span class="hljs-comment">// Other details omitted for brevity</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        <span class="hljs-comment">// Extract the token from the Authorization header</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">authorizationHeader</span> <span class="hljs-operator">=</span> request.getHeader(HttpHeaders.AUTHORIZATION);

        <span class="hljs-keyword">if</span> (authorizationHeader != <span class="hljs-literal">null</span> &amp;&amp; authorizationHeader.startsWith(<span class="hljs-string">&quot;Bearer &quot;</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authorizationHeader.replace(<span class="hljs-string">&quot;Bearer &quot;</span>, <span class="hljs-string">&quot;&quot;</span>);
            <span class="hljs-comment">// Identify the user by token using the above loadUserByToken() service method</span>
            <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> userDetailsService.loadUserByToken(token);

            <span class="hljs-keyword">if</span> (userDetails != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// Create Authentication object as authenticated principal</span>
                <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> UsernamePasswordAuthenticationToken.authenticated(
                        userDetails.getUsername(), <span class="hljs-literal">null</span>, userDetails.getAuthorities()
                );
                <span class="hljs-comment">// Set Authentication in SecurityContext</span>
                authenticationFacade.setAuthentication(authentication);
            }
        }

        filterChain.doFilter(request, response);
    }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Configure TokenVerficiationFilter</h3><p class="Paragraph_paragraph__90U8D">Finally let&#x27;s configure <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">TokenVerficiationFilter</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration to let all the requests pass through it before attempting to authenticate the user with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UsernamePasswordAuthenticationFilter</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/verify-token/src/main/java/com/facadecode/spring/security/config/ApiSecurityConfig.java" target="_blank">ApiSecurityConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">apiFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
    http
        .csrf().disable()
        .addFilterBefore(tokenVerificationFilter, UsernamePasswordAuthenticationFilter.class)
        .sessionManagement(
            httpSecuritySessionManagementConfigurer -&gt;
                    httpSecuritySessionManagementConfigurer.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        )
        .authorizeRequests(auth -&gt; auth
            .antMatchers(POST, API_AUTH_TOKEN).permitAll()
            .antMatchers(GET, PUBLIC_API_LIST).permitAll()
            .anyRequest().authenticated()
        );
    <span class="hljs-keyword">return</span> http.build();
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Restart the application and get the token generated for <em>Admin</em> user credentials by sending a POST request to <u>GenerateToken</u> API.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>UUID token generated for Admin user credentials on successful authentication</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson24-01.png" alt="UUID token generated for Admin user credentials on successful authentication"/></div><p class="Paragraph_paragraph__90U8D">Now choose the Authorization type as <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Bearer Token</mark>, and paste the generated token in the Token Field. If we send a GET request to <u>ListStudents</u> API with the Bearer Token set in the Authorization header, the request will be intercepted by <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">TokenVerificationFilter</mark> to authenticate the request by the token. Once the authentication is success the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object is set in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark> for Spring Security to authorize the user in the appropriate layers. And we will get the response back for the authorized user request like below:</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>List of students response for the authorized token issed for Admin user</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson24-02.png" alt="List of students response for the authorized token issed for Admin user"/></div><p class="Paragraph_paragraph__90U8D">Similarly you can test the same for different users and their authorized actions. You can also use the token after it&#x27;s expiry time to see <em>403 Forbidden</em> error which then requires you to re-authenticate the user to generate a new token.</p></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/verify-token" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="persist-token"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Persist Token</a></span><span class="float-end"><a href="invalidate-token">Invalidate Token<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/verify-token","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>