<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/acb8172d7678da98.css" as="style"/><link rel="stylesheet" href="/_next/static/css/acb8172d7678da98.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/generate-jwt-bf123dff6effc03f.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->27<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/generate-jwt" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Generate JWT</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">Our first step is to replace the random UUID token generation with JWT. But before generating the JWT, we will add some useful configuration in the properties and get it via <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@ConfigurationProperties</mark> class.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/generate-jwt/src/main/resources/application.properties" target="_blank">application.properties</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
jwt.token.base64-encoded-secret-key=/EbiawupzOqD8MlXgzlRetQfLL5vbD65jE6Q2MJF/Gg=
jwt.token.expiry-in-seconds=<span class="hljs-number">600</span>
jwt.token.signing-algorithm=HS256
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">These properties need no explanation except for the first one. JWT must be signed with a strong secret key based on the signing algorithm we choose, else the signing algorithm will throw Weak secret key error. JJWT provides a utility to generate this SecretKey for us. We can Base64 encode it to a string and store it in a secure place and not in properties as we do.</p></section><section><h3 class="fw-light mt-5 mb-2">Generate SecretKey using JJWT utility</h3><p class="Paragraph_paragraph__90U8D">I have included below test class in this chapter, and this can be used to generate Base64 encoded SecretKey, and it also assert the equality of the decoded SecretKey with the original one.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/generate-jwt/src/test/java/com/facadecode/spring/security/SecretKeyGeneratorTest.java" target="_blank">SecretKeyGeneratorTest.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecretKeyGeneratorTest</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">SignatureAlgorithm</span> <span class="hljs-variable">ALGORITHM</span> <span class="hljs-operator">=</span> SignatureAlgorithm.HS256;

  <span class="hljs-meta">@Test</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateBase64EncodedSecretKeyString</span><span class="hljs-params">()</span> {
      <span class="hljs-comment">// Generate and Base64 encode to string to store it in disk</span>
      <span class="hljs-type">SecretKey</span> <span class="hljs-variable">originalKey</span> <span class="hljs-operator">=</span> Keys.secretKeyFor(ALGORITHM);
      <span class="hljs-type">String</span> <span class="hljs-variable">base64EncodedKeyString</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(originalKey.getEncoded());
      System.out.println(<span class="hljs-string">&quot;Base64 encoded secret key generated below, store it in a secure place&quot;</span>);
      System.out.println(base64EncodedKeyString);

      <span class="hljs-comment">// Base64 decode from string and regenerate SecretKey</span>
      <span class="hljs-type">byte</span>[] base64DecodedKeyBytes = Base64.getDecoder().decode(base64EncodedKeyString);
      <span class="hljs-type">SecretKey</span> <span class="hljs-variable">regeneratedKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(base64DecodedKeyBytes, <span class="hljs-number">0</span>, base64DecodedKeyBytes.length, ALGORITHM.getJcaName());

      <span class="hljs-keyword">assert</span> originalKey.equals(regeneratedKey);
  }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">JWT configuration properties</h3><p class="Paragraph_paragraph__90U8D">Let&#x27;s create a <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@ConfigurationProperties</mark> class with variables corresponding to each properties we defined earlier.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/generate-jwt/src/main/java/com/facadecode/spring/security/config/JWTConfig.java" target="_blank">JWTConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = &quot;jwt.token&quot;)</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JWTConfig</span> {
    <span class="hljs-keyword">private</span> String base64EncodedSecretKey;

    <span class="hljs-keyword">private</span> Integer expiryInSeconds;

    <span class="hljs-keyword">private</span> String signingAlgorithm;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Add a method to regenerate <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark> object from the Base64 encoded string in the properties similar to the above test class.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/generate-jwt/src/main/java/com/facadecode/spring/security/config/JWTConfig.java" target="_blank">JWTConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> SecretKey <span class="hljs-title function_">getSecretKey</span><span class="hljs-params">()</span> {
    <span class="hljs-type">byte</span>[] base64DecodedKeyBytes = Base64.getDecoder().decode(base64EncodedSecretKey);
    <span class="hljs-type">SecretKey</span> <span class="hljs-variable">secretKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(base64DecodedKeyBytes, <span class="hljs-number">0</span>,
    base64DecodedKeyBytes.length, <span class="hljs-built_in">this</span>.getSignatureAlgorithm().getJcaName());
    <span class="hljs-keyword">return</span> secretKey;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Add another method to get signing algorithm object of type <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SignatureAlgorithm</mark> from the signing-algorithm properties.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/generate-jwt/src/main/java/com/facadecode/spring/security/config/JWTConfig.java" target="_blank">JWTConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> SignatureAlgorithm <span class="hljs-title function_">getSignatureAlgorithm</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> SignatureAlgorithm.valueOf(signingAlgorithm);
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Add couple more methods to get token issue time (current time) and expiry time (issue time + expiry-in-seconds). In our case we have configured the token expiry time to be 600 seconds from the issue time.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/generate-jwt/src/main/java/com/facadecode/spring/security/config/JWTConfig.java" target="_blank">JWTConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getIssueTime</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis());
}

<span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getExpiryTime</span><span class="hljs-params">(Date issueDate)</span> {
    <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();
    calendar.setTime(issueDate);
    calendar.add(Calendar.SECOND, expiryInSeconds);
    <span class="hljs-keyword">return</span> calendar.getTime();
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Generate JWT</h3><p class="Paragraph_paragraph__90U8D">Finally we will replace the random UUID token generation in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark> with the below JWT generation using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtBuilder</mark> class provided by <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Jwts</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/generate-jwt/src/main/java/com/facadecode/spring/security/service/AuthenticationService.java" target="_blank">AuthenticationService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String username, String password)</span> {
    <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> UsernamePasswordAuthenticationToken.unauthenticated(username, password);
    authentication = authenticationManager.authenticate(authentication);
    
    <span class="hljs-type">String</span> <span class="hljs-variable">accessToken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (authentication.isAuthenticated()) {
        authenticationFacade.setAuthentication(authentication);
        
        <span class="hljs-comment">// Generate JWT</span>
        accessToken = Jwts.builder()
            .setSubject(authentication.getName())
            .setIssuedAt(jwtConfig.getIssueTime())
            .setExpiration(jwtConfig.getExpiryTime(jwtConfig.getIssueTime()))
            .setId(UUID.randomUUID().toString())
            .addClaims(
                Collections.singletonMap(<span class="hljs-string">&quot;authorities&quot;</span>, authentication.getAuthorities()
                        .stream()
                        .map(GrantedAuthority::getAuthority)
                        .collect(Collectors.toList())
                )
            )
            .signWith(jwtConfig.getSecretKey(), jwtConfig.getSignatureAlgorithm())
            .compact();
    }
    
    <span class="hljs-keyword">return</span> accessToken;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Here we are setting the Subject as the name of the authenticated user, which tells us whom the token is issued to. We are setting the date &amp; time the token was issued and it&#x27;s expiry time. We are assigning a random UUID to uniquely identify the token in order to prevent token replay attacks in case the token is invalidate before it&#x27;s expiry time. We have added the list of authorities of the authenticated user as custom claims using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">addClaim()</mark>. Finally we are signing the token using the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SignatureAlgorithm</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtConfig</mark>.</p><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">We have changed the variable name from <em>token</em> to <em>accessToken</em> in both <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationController</mark> as it is no more a simple opaque token. This new variable name better reflects its purpose that it now contains both authentication and authorization information necessary enough to access the resources in our application.</p></section></section><section><h3 class="fw-light mt-5 mb-2">Tidy up and Test</h3><p class="Paragraph_paragraph__90U8D">We are no more required to store the token and it&#x27;s expiry time in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record in the database. JWT is now self-contained to identify who the user is and what are they allowed to do in a given timeframe. Let&#x27;s tidy up the code a little by removing the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark> and it&#x27;s pre-authorize condition from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityConstants</mark>.</p><p class="Paragraph_paragraph__90U8D">Restart the application and send a POST request to <u>GenerateToken</u> API and see the JWT generated like below.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>JWT generated for Admin user credentials on successful authentication</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson27-01.png" alt="JWT generated for Admin user credentials on successful authentication"/></div><p class="Paragraph_paragraph__90U8D">We can now go to JWT&#x27;s <a href="https://jwt.io/">official page</a> to unpack the token and see what it contains. Before pasting the generated JWT, check the Checkbox having label <em>secret base64 encoded</em> in <em>Verify Signature</em> section, and replace the string <em>your-256-bit-secret</em> in the text box with the Base64 encoded <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark> string from the properties. Now paste the generated JWT on the left hand side to see the Header and Payload details of the token on the right hand side.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>Signature verified and decoded JWT with the payload matching the Admin claims</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson27-01.png" alt="Signature verified and decoded JWT with the payload matching the Admin claims"/></div><p class="Paragraph_paragraph__90U8D">We can also use JJWT library to parse the content of JWT using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParserBuilder</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Jwts</mark> class as we will see in the next chapter while verifying the JWT.</p></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/generate-jwt" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="json-web-token"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>JSON Web Token</a></span><span class="float-end"><a href="verify-jwt">Verify JWT<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/generate-jwt","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>