<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/01b065b5c84bc69d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/01b065b5c84bc69d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/assign-permissions-e0b21438caea1f4b.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->12<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/assign-permissions" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Assign Permissions</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">In this chapter we will provide all the roles and permissions associated with each user in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> object using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">authorities()</mark>.</p></section><section><h3 class="fw-light mt-5 mb-2">ROLE_ Prefix</h3><p class="Paragraph_paragraph__90U8D">Remember we have applied both role-based as well as permission-based access restrictions to different APIs using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasRole()</mark> and  <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration. We have to provide both roles and permissions for each user in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> object.</p><p class="Paragraph_paragraph__90U8D">But as mentioned in <a href="https://github.com/SankaranarayananMurugan/spring-security-guide/tree/main/07.%20Role%20Based%20Authorization" target="_blank">Chapter 7</a>, we can not use them both on <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserBuilder</mark> class, as the latter will always override the authorities set by the former. So we can only use <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">authorities()</mark> by combining roles and permissions, where each role must be prefixed with <strong>ROLE_</strong>.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s update the existing <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">getRoles()</mark> to append the prefix <strong>ROLE_</strong> with each role assigned to the user as below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/assign-permissions/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailsService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">getRoles</span><span class="hljs-params">(Set&lt;AppRole&gt; roles)</span> {
    <span class="hljs-keyword">return</span> roles.stream()
          .map(role -&gt; String.format(<span class="hljs-string">&quot;ROLE_%s&quot;</span>, role.getName().name()))
          .collect(Collectors.toSet());
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Consolidate Permissions</h3><p class="Paragraph_paragraph__90U8D">As one user has many roles and each role has many permissions, we need to combine all the permissions associated with each roles assigned to the user like below in a private method in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DbUserDetailService</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/assign-permissions/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailsService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">getPermissions</span><span class="hljs-params">(Set&lt;AppRole&gt; roles)</span> {
    <span class="hljs-keyword">return</span> roles.stream()
        .flatMap(role -&gt; role.getPermissions().stream())
        .map(permission -&gt; permission.getName().name())
        .collect(Collectors.toSet());
}    
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Combine Roles and Permissions in Authorities</h3><p class="Paragraph_paragraph__90U8D">Now we will remove the roles() method and use only authorities() in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">User.builder()</mark> to combine roles and permissions for each user as below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/assign-permissions/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailsService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> List&lt;UserDetails&gt; <span class="hljs-title function_">getAllUserDetails</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> appUserRepository.findAll()
        .stream()
        .map(appUser -&gt; User.builder()
                .username(appUser.getUsername())
                .password(appUser.getPassword())
                .authorities(<span class="hljs-built_in">this</span>.getRolesAndPermissions(appUser.getRoles()))
                .build()
        )
        .collect(Collectors.toList());
}

<span class="hljs-keyword">private</span> String[] getRolesAndPermissions(Set&lt;AppRole&gt; appRoles) {
    Set&lt;String&gt; roles = <span class="hljs-built_in">this</span>.getRoles(appRoles);
    Set&lt;String&gt; permissions = <span class="hljs-built_in">this</span>.getPermissions(appRoles);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;() {
        {
            addAll(roles);
            addAll(permissions);
        }
    }.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Finally we can expect each users to have their roles and permissions combined in the form of authorities as mentioned in the below table.</p><table class="table table-striped mb-4"><thead><tr><th>User</th><th>Authorities</th></tr></thead><tbody><tr><td>Gru, Lucy</td><td>ROLE_INSTRUCTOR <br/> CREATE_COURSE <br/> UPDATE_COURSE <br/> PLAY_COURSE <br/> VIEW_PROFILE</td></tr><tr><td>Bob, Kevin, Stuart</td><td>ROLE_STUDENT <br/> PLAY_COURSE <br/> VIEW_PROFILE</td></tr><tr><td>Admin</td><td>ROLE_ADMIN <br/> LIST_STUDENTS <br/> LIST_INSTRUCTORS</td></tr></tbody></table><p class="Paragraph_paragraph__90U8D">Restart the application and send a request to <u>PlayCourse</u> API for any course as either a Student (Bob) or an Instructor (Gru). We can see the Course detail as the response (the response is similar to <u>GetCourse</u> API, let&#x27;s not worry about what the API is doing, we are only interested in securing it from Admin).</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>Course detail response for Gru (Instructor) who has PLAY_COURSE authority</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson11-01.png" alt="Course detail response for Gru (Instructor) who has PLAY_COURSE authority"/></div><p class="Paragraph_paragraph__90U8D">We will get <em>403 Forbidden</em> error while we send the same request as an Admin user as he does not have PLAY_COURSE authority.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>403 Forbidden error for Admin who does not have PLAY_COURSE authority</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson11-02.png" alt="403 Forbidden error for Admin who does not have PLAY_COURSE authority"/></div></section><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">So far we have just restricted the access to the <u>PlayCourse</u> API for the Admin user using Permissions instead of Roles. But we are yet to restrict the Student user to play only the course they are enrolled with, as per the Security Objective defined in <a href="https://github.com/SankaranarayananMurugan/spring-security-guide/tree/main/01.%20Introduction" target="_blank">Chapter 1</a>.</p></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/assign-permissions" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="define-permissions"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Define Permissions</a></span><span class="float-end"><a href="remove-role-based-access">Remove Role Based Access<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/assign-permissions","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>