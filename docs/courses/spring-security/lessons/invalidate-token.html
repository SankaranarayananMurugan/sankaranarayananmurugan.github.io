<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/acb8172d7678da98.css" as="style"/><link rel="stylesheet" href="/_next/static/css/acb8172d7678da98.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/invalidate-token-e9ea438da2d79ff6.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->25<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/invalidate-token" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Invalidate Token</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">Any web application allows the user to voluntarily logout or expires their session (not necessarily HttpSession) in case of inactivity for a long time. This can be done from SPA (Single Page Application) by just getting rid of the token stored somewhere and redirecting to the Login page. But the proper way to make this happen is to handle it with a dedicated and secured API to invalidate the token.</p></section><section><h3 class="fw-light mt-5 mb-2">Invalidate token service</h3><p class="Paragraph_paragraph__90U8D">We will create a <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark> in order to specifically update the <em>token</em> and <em>tokenExpiryTime</em> to null for the authenticated user identified by <em>username</em>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// Other methods omitted for brevity</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteToken</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-type">AppUser</span> <span class="hljs-variable">appUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.get(username);
        appUser.setToken(<span class="hljs-literal">null</span>);
        appUser.setTokenExpiryTime(<span class="hljs-literal">null</span>);
        appUserRepository.save(appUser);
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Now we will call the above method from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark> by passing the <em>username</em> retrieved from the authenticated <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object stored in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/service/AuthenticationService.java" target="_blank">AuthenticationService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationService</span> {
    <span class="hljs-comment">// Other methods omitted for brevity</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateToken</span><span class="hljs-params">()</span> {
        userService.deleteToken(authenticationFacade.getAuthentication().getName());
    }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Invalidate token API</h3><p class="Paragraph_paragraph__90U8D">Let&#x27;s create a REST API which calls the above service method to invalidate the token.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/controller/AuthenticationController.java" target="_blank">AuthenticationController.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(&quot;auth&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationController</span> {
    <span class="hljs-comment">// Other details omitted for brevity</span>

    <span class="hljs-meta">@DeleteMapping(&quot;token&quot;)</span>
    <span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title function_">invalidateToken</span><span class="hljs-params">()</span> {
        authenticationService.invalidateToken();
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Secure delete token service</h3><p class="Paragraph_paragraph__90U8D">Similar to <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> service method we should not allow anyone to delete the token anonymously. We will secure the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> service method with the same pre-authorize condition as in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> to ensure only the authenticated user deletes his own token. Let&#x27;s define a constant variable in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authority</mark> class exclusively for authorizing the user to delete the token and annotate the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/invalidate-token/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@PreAuthorize(Authority.DELETE_TOKEN)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteToken</span><span class="hljs-params">(String username)</span> {
    <span class="hljs-comment">// Other details omitted for brevity</span>
}
</span></code></pre></div><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">Please note we do not need to change anything in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark>, as we have configured <em>/auth/token</em> endpoint to be public only for POST method. So DELETE method is secured by default letting only the authenticated user to delete/invalidate his own token.</p></section><p class="Paragraph_paragraph__90U8D">Restart the application, and generate a token from <u>GenerateToken</u> API with Admin user credential. Now send a DELETE request to the same endpoint with the generated token as Bearer Token. This will reset the token and tokenExpiryTime column for the Admin user to null in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">APP_USER</mark> table. We can no more use the same token for any protected APIs for the Admin user.</p></section><section><h3 class="fw-light mt-5 mb-2">Downside of Opaque Tokens</h3><p class="Paragraph_paragraph__90U8D">With so many steps to implement token-based authentication mechanism, it is quite not simpler than the out of the box Basic Auth. Though it is quite effective and efficient and addresses most of the issues of Basic Auth but it also comes along with its own limitations. And this is not because of the authentication mechanism itself, but because of the type of the token we are using so far.</p><ul><li>These tokens are called <strong>opaque tokens</strong>, as the name implies we can not get any information out of the random string. There is no way to verify from the token to whom it was issued to (Subject).</li><li>Single Page Applications (SPA) receiving this token can not decide what the user is allowed to do in the user interface from the token. It has to depend on a separate endpoint (in most cases it ends with url <em>/me</em> or <em>/profile</em>) to get the user profile and their permissions. These tokens can only be used as a means of authentication and not for authorization.</li><li>As these are opaque tokens, it should always be backed by a persistent datastore. In our case we had to associate the token with the user and it&#x27;s expiry time in the database along with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record.</li><li>API request spanning multiple microservices, where the token has to be relayed across each microservice requires a round trip to the datastore in each microservice just to validate the token.</li></ul></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/invalidate-token" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="verify-token"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Verify Token</a></span><span class="float-end"><a href="json-web-token">JSON Web Token<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/invalidate-token","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>