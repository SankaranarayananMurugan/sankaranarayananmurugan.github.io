<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/acb8172d7678da98.css" as="style"/><link rel="stylesheet" href="/_next/static/css/acb8172d7678da98.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/verify-jwt-a8d6db1f13f8d84b.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->28<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/verify-jwt" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Verify JWT</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">As JWT is self-contained with the Subject information to whom the token is issued, we do not need to associate the token with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record in the database. Because of which we no longer need to identify the user from the database as well. All we need is just to verify the signature using the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark> and parse the JWT to construct the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as authenticated principal.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s update <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">TokenVerificationFilter</mark>, by replacing the existing logic to identify the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> from the database using opaque token, with the below code:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/verify-jwt/src/main/java/com/facadecode/spring/security/filters/TokenVerificationFilter.java" target="_blank">TokenVerificationFilter.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Override</span>  
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, 
            HttpServletResponse response, 
            FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
    <span class="hljs-type">String</span> <span class="hljs-variable">authorizationHeader</span> <span class="hljs-operator">=</span> request.getHeader(HttpHeaders.AUTHORIZATION);

    <span class="hljs-keyword">if</span> (authorizationHeader != <span class="hljs-literal">null</span> &amp;&amp; authorizationHeader.startsWith(<span class="hljs-string">&quot;Bearer &quot;</span>)) {
        <span class="hljs-type">String</span> <span class="hljs-variable">accessToken</span> <span class="hljs-operator">=</span> authorizationHeader.replace(<span class="hljs-string">&quot;Bearer &quot;</span>, <span class="hljs-string">&quot;&quot;</span>);
        <span class="hljs-comment">// Parse JWT using the SecretKey</span>
        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> Jwts.parserBuilder()
            .setSigningKey(jwtConfig.getSecretKey())
            .build()
            .parseClaimsJws(accessToken)
            .getBody();

        <span class="hljs-comment">// Check if JWT has expired</span>
        <span class="hljs-keyword">if</span> (claims.getExpiration().after(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())) {
            <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> UsernamePasswordAuthenticationToken.authenticated(
                    claims.getSubject(), <span class="hljs-literal">null</span>, <span class="hljs-built_in">this</span>.getAuthorities(claims)
            );
            authenticationFacade.setAuthentication(authentication);
        }
    }

    filterChain.doFilter(request, response);
}

<span class="hljs-keyword">private</span> List&lt;GrantedAuthority&gt; <span class="hljs-title function_">getAuthorities</span><span class="hljs-params">(Claims claims)</span> {
    <span class="hljs-keyword">return</span> ((List&lt;String&gt;) claims.get(<span class="hljs-string">&quot;authorities&quot;</span>)).stream()
        .map(SimpleGrantedAuthority::<span class="hljs-keyword">new</span>)
        .collect(Collectors.toList());
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Jwts</mark> provides another Builder class <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParserBuilder</mark> to build <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParser</mark> object. We are calling <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">parseClaimsJws()</mark> method on <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParser</mark> which accepts <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark> to verify the signature and parse the content of JWT.</p><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">You may notice another parser method <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">parseClaimsJwt()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JwtParser</mark>. But we are using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">parseClaimsJws()</mark> because signed JWT tokens are called JWS (not JWT), and in our case we want to parse the JWS signed with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecretKey</mark>.</p></section><p class="Paragraph_paragraph__90U8D">The parsed JWT body has the information we saw earlier in the decoded payload data in the JWT official page. Now instead of identifying the user and his authorities from the database, we can get the same from the JWT payload. But before creating <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object form the JWT payload we have to check if the token has expired.</p></section><section><h3 class="fw-light mt-5 mb-2">Tidy up and Test</h3><p class="Paragraph_paragraph__90U8D">We can remove the <em>token</em> and <em>tokenExpiryTime</em> from the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> entity as we are not using it anymore. We can also tidy up some of the code related to opaque token which are no more relevant with JWT.</p><ul><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">invalidateToken()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationController</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark>.</li><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark>.</li><li>Remove pre-authorize condition defined for <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">deleteToken()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityConstants</mark>.</li><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">loadUserByToken()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DbUserDetailsService</mark>.</li><li>Remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">findByTokenAndTokenExpiryTimeGreaterThan()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUserRepository</mark>.</li></ul><p class="Paragraph_paragraph__90U8D">Restart the application and get the JWT generated for <em>Admin</em> user credentials by sending a POST request to <u>GenerateToken</u> API.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>JWT generated for Admin user credentials on successful authentication</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson28-01.png" alt="JWT generated for Admin user credentials on successful authentication"/></div><p class="Paragraph_paragraph__90U8D">Now choose the Authorization type as <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Bearer Token</mark>, and paste the generated JWT in the Token Field. If we send a GET request to <u>ListStudents</u> API with JWT as the Bearer Token in the Authorization header, <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">TokenVerificationFilter</mark> will verify the signature of JWS and parse the content to create <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as an authenticated principal. Rest of the token-based authentication process remains the same as with our opaque token.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>List of students response for the authorized JWT issed for Admin user</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson28-02.png" alt="List of students response for the authorized JWT issed for Admin user"/></div><p class="Paragraph_paragraph__90U8D">Similarly you can test for all the other protected resources for all the users with their respective JWT.</p></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/verify-jwt" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="generate-jwt"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Generate JWT</a></span><span class="float-end"></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/verify-jwt","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>