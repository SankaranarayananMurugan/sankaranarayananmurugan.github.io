<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/01b065b5c84bc69d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/01b065b5c84bc69d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/pre-authorize-d7f8163130d800fe.js" defer=""></script><script src="/_next/static/kNMNrEuP_QGr-XeZY3XQO/_buildManifest.js" defer=""></script><script src="/_next/static/kNMNrEuP_QGr-XeZY3XQO/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->14<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/pre-authorize" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">PreAuthorize</h1><p class="Heading_underline__sSwtx"></p><h3 class="fw-light mt-5 mb-2">Service layer security</h3><p class="Paragraph_paragraph__90U8D">So far we have secured the API URLs using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">antMatchers()</mark> based on roles and permissions in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration. For few reasons discussed in this <a href="https://docs.spring.io/spring-security/reference/servlet/exploits/firewall.html#page-title" target="_blank">section</a>, Spring Security recommends not to rely entirely on Web request security. Instead Security defined at the Service layer is much more robust and harder to bypass.</p><p class="Paragraph_paragraph__90U8D">Service layer security is about securing the service methods which can be achieved using Spring Security&#x27;s Method security annotations. As recommended by Spring Security, let&#x27;s constrain ourselves using simple antPatterns in the Web request security, and move the permission based access model to the Service layer using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PreAuthorize</mark> annotation.</p></section><section><h3 class="fw-light mt-5 mb-2">@PreAuthorize</h3><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PreAuthorize</mark> annotation provides expression-based access control using SpEL (Spring Expression Language). It checks the given expression before entering the method. Some of the valid PreAuthorize annotations are:</p><ul class="mx-5 list-unstyled"><li><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PreAuthorize(&quot;hasRole(&#x27;ROLE_ADMIN&#x27;)&quot;)</mark></li><li><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PreAuthorize(&quot;hasAuthority(&#x27;LIST_STUDENTS&#x27;)&quot;)</mark></li></ul><p class="Paragraph_paragraph__90U8D">Here the expression resembles the method we used along with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">antMatchers()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration. We will use <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark> expression with the appropriate <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEnum</mark> instances to secure the service methods by following the same permission-based access model like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/pre-authorize/src/main/java/com/facadecode/spring/security/service/CourseService.java" target="_blank">CourseService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(T(com.thecodefacts.spring.security.enums.PermissionEnum).PLAY_COURSE.name())&quot;)</span>  
<span class="hljs-keyword">public</span> Course <span class="hljs-title function_">play</span><span class="hljs-params">(Long courseId)</span> {
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">SpEL expects the fully qualified name of the PermissionEnum instances. It may seem verbose but it is better to use Enums for type safety reasons rather than using String literals. As the SpEL expressions are validated on application startup, any typo mistake in the expression using enums will throw Exception.</p></section><section><h3 class="fw-light mt-5 mb-2">SpEL expression constants</h3><p class="Paragraph_paragraph__90U8D">SpEL expression must always be a String constant. Let&#x27;s move all the possible expressions in a constant class like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/pre-authorize/src/main/java/com/facadecode/spring/security/constant/SecurityConstants.java" target="_blank">Authority.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Authority</span> {  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LIST_STUDENTS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasAuthority(T(com.thecodefacts.spring.security.enums.PermissionEnum).LIST_STUDENTS.name())&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LIST_INSTRUCTORS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasAuthority(T(com.thecodefacts.spring.security.enums.PermissionEnum).LIST_INSTRUCTORS.name())&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">VIEW_PROFILE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasAuthority(T(com.thecodefacts.spring.security.enums.PermissionEnum).VIEW_PROFILE.name())&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CREATE_COURSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasAuthority(T(com.thecodefacts.spring.security.enums.PermissionEnum).CREATE_COURSE.name())&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">UPDATE_COURSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasAuthority(T(com.thecodefacts.spring.security.enums.PermissionEnum).UPDATE_COURSE.name())&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PLAY_COURSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hasAuthority(T(com.thecodefacts.spring.security.enums.PermissionEnum).PLAY_COURSE.name())&quot;</span>;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Now we can simplify the above <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PreAuthorize</mark> annotation using the constants like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/pre-authorize/src/main/java/com/facadecode/spring/security/service/CourseService.java" target="_blank">CourseService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@PreAuthorize(Authority.PLAY_COURSE)</span>
<span class="hljs-keyword">public</span> Course <span class="hljs-title function_">play</span><span class="hljs-params">(Long courseId)</span> {
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Refactor HttpSecurity</h3><p class="Paragraph_paragraph__90U8D">Since we have moved all the permission based access controls to the respective service methods, we no longer have to secure the corresponding REST APIs in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration. Also as recommended by Spring Security we will use &quot;deny-by-default&quot; approach using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">anyRequest().authenticated()</mark> and use simple ant paths to just permit the public APIs.</p><p class="Paragraph_paragraph__90U8D">More importantly in order to enable method security annotations like <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PreAuthorize</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PostAuthorize</mark> annotate <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ApiSecurityConfig</mark> with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@EnableGlobalMethodSecurity</mark> with <em>prePostEnabled</em> value as <em>true</em>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/pre-authorize/src/main/java/com/facadecode/spring/security/config/ApiSecurityConfig.java" target="_blank">ApiSecurityConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiSecurityConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">apiFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .csrf().disable()
            .authorizeRequests(auth -&gt; auth
                .antMatchers(GET, PUBLIC_API_LIST).permitAll()
                .anyRequest().authenticated()
            )
            .httpBasic();
        <span class="hljs-keyword">return</span> http.build();
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">There will not be any change in the Security behaviour with the shift from Web request security to Service layer security. All the authenticated requests will be handled by the APIs now, but only authorized requests makes into the Service method. Any unauthorized request to the Service method will be thrown back with <em>403 Forbidden</em> error by the Method security annotation.</p></section><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">You may often find developers using Method security annotations in Controller methods, though it is not restricted to do so. But Spring Security recommends applying them to the Service layer because Controller is simply the incorrect architectural layer to implement authorization decisions concerning services layer methods or domain object instances.</p></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/pre-authorize" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="remove-role-based-access"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Remove Role Based Access</a></span><span class="float-end"><a href="post-authorize">PostAuthorize<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/pre-authorize","query":{},"buildId":"kNMNrEuP_QGr-XeZY3XQO","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>