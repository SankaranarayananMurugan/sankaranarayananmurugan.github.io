<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/a797d36a22bff2c4.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a797d36a22bff2c4.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-7269df826c4d1d8b.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4e35396f25479038.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/734-501744163e7117ce.js" defer=""></script><script src="/_next/static/chunks/92-440e540aa7fbcfdf.js" defer=""></script><script src="/_next/static/chunks/637-485e8fd7a429178a.js" defer=""></script><script src="/_next/static/chunks/827-6a9167eb1a9387e0.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/remove-role-based-access-027f867f01eaf6b0.js" defer=""></script><script src="/_next/static/_e-p_C0xJot5hRdMGnMZh/_buildManifest.js" defer=""></script><script src="/_next/static/_e-p_C0xJot5hRdMGnMZh/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->13<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Download patch"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/remove-role-based-access" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Github repository"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Copy link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Remove Role-Based Access</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">We have intentionally left the role-based access restrictions to few APIs in order to show you how to combine roles and permissions together. But going forward we will replace it completely with permission-based access control.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s modify <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration by replacing <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasRole()</mark> with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark> for each API using the appropriate permissions we have created in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEnum</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/remove-role-based-access/src/main/java/com/facadecode/spring/security/config/ApiSecurityConfig.java" target="_blank">ApiSecurityConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">apiFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
    http
        .csrf().disable()
        .authorizeRequests(auth -&gt; auth
                .antMatchers(GET, PUBLIC_API_LIST).permitAll()
                .antMatchers(API_LIST_STUDENTS).hasAuthority(LIST_STUDENTS.name())
                .antMatchers(API_LIST_INSTRUCTORS).hasAuthority(LIST_INSTRUCTORS.name())
                .antMatchers(API_VIEW_PROFILE).hasAuthority(VIEW_PROFILE.name())
                .antMatchers(POST, API_CREATE_COURSES).hasAuthority(CREATE_COURSE.name())
                .antMatchers(PUT, API_UPDATE_COURSES).hasAuthority(UPDATE_COURSE.name())
                .antMatchers(API_PLAY_COURSE).hasAuthority(PLAY_COURSE.name())
                .anyRequest().authenticated()
        )
        .httpBasic();
    <span class="hljs-keyword">return</span> http.build();
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Remove roles from Authorities</h3><p class="Paragraph_paragraph__90U8D">With only <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark> used to secure each REST API we no longer need to provide the roles assigned to each user. So we can directly map <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">getPermissions()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">authorities()</mark> and remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">getRoles()</mark> and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">getRolesAndPermissions()</mark> altogether in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DbUserDetailService</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/remove-role-based-access/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" data-bs-title="Copy code"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> List&lt;UserDetails&gt; <span class="hljs-title function_">getAllUserDetails</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> appUserRepository.findAll()
        .stream()
        .map(appUser -&gt; User.builder()
                .username(appUser.getUsername())
                .password(appUser.getPassword())
                .authorities(<span class="hljs-built_in">this</span>.getPermissions(appUser.getRoles()))
                .build()
        )
        .collect(Collectors.toList());
}

<span class="hljs-keyword">private</span> String[] getPermissions(Set&lt;AppRole&gt; roles) {
    <span class="hljs-keyword">return</span> roles.stream()
        .flatMap(role -&gt; role.getPermissions().stream())
        .map(permission -&gt; permission.getName().name())
        .collect(Collectors.toSet())
        .toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);
} 
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">This got even more simplified where we no longer required to combine roles (by prefixing it with ROLE_) and permissions. And we no longer need to care about the authorities override issues we highlighted in Chapter 7.</p><p class="Paragraph_paragraph__90U8D">Finally we will have each APIs secured against its own permission, and users with only the permissions corresponding to the APIs they can access as their authorities as mentioned in the below table.</p><table class="table table-striped mb-4"><thead><tr><th>User</th><th>Authorities</th></tr></thead><tbody><tr><td>Bob, Kevin, Stuart</td><td>PLAY_COURSE, VIEW_PROFILE</td></tr><tr><td>Gru, Lucy</td><td>CREATE_COURSE, UPDATE_COURSE, PLAY_COURSE, VIEW_PROFILE</td></tr><tr><td>Admin</td><td>LIST_STUDENTS, LIST_INSTRUCTORS, VIEW_PROFILE</td></tr></tbody></table></section><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><ol><li>There will be no change in the API access behaviour after replacing the Role-based API access with Permission-based API access.</li><li>In addition to Play Course, we have secured Update Course as well as View Profile APIs with its own permissions, but still these three APIs have not met the Security Objectives defined in Chapter 1</li></ol></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Download patch"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/remove-role-based-access" target="_blank" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Github repository"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link" data-bs-toggle="tooltip" data-bs-title="Copy link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i><a href="/courses/spring-security/lessons/assign-permissions">Assign Permissions</a></span><span class="float-end"><a href="/courses/spring-security/lessons/pre-authorize">PreAuthorize</a><i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="/courses/spring-security">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/remove-role-based-access","query":{},"buildId":"_e-p_C0xJot5hRdMGnMZh","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>