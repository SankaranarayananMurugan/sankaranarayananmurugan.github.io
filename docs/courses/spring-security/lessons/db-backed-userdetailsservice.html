<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/01b065b5c84bc69d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/01b065b5c84bc69d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/db-backed-userdetailsservice-2d537f671d68093a.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->20<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/db-backed-userdetailsservice" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Database Backed UserDetailsService</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">Remember we are using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">InMemoryUserDetailsManager</mark>, the default non-persistant implementation of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetailsService</mark> provided by Spring Security. It is mainly intended for testing and demonstration purposes. Any change in the user details in the database requires us to restart the application. We need an implementation backed by database for production.</p></section><section><h3 class="fw-light mt-5 mb-2">UserDetailsService</h3><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetailsService</mark> is used by <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/passwords/dao-authentication-provider.html#servlet-authentication-daoauthenticationprovider" target="_blank">DaoAuthenticationProvider</a> for retrieving a username, password, and other attributes for authenticating with a username and password. We can define custom authentication by exposing a custom <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetailsService</mark> as a bean.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s implement it using our <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DbUserDetailsService</mark> bean by overriding the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">loadUserByUsername()</mark> method.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/db-backed-userdetailsservice/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailsService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DbUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> {
    <span class="hljs-comment">// Other details omitted for brevity</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException {
        <span class="hljs-type">AppUser</span> <span class="hljs-variable">appUser</span> <span class="hljs-operator">=</span> appUserRepository.findByUsername(username)
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(String.format(<span class="hljs-string">&quot;User %s not found&quot;</span>, username)));

        <span class="hljs-keyword">return</span> User.builder()
                .username(appUser.getUsername())
                .password(appUser.getPassword())
                .authorities(<span class="hljs-built_in">this</span>.getPermissions(appUser.getRoles()))
                .build();
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Here we are using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUserRepository</mark> to find the user by <em>username</em> from the database. And then we are returning the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> object mapped from the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> object.</p><p class="Paragraph_paragraph__90U8D">Once we remove the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">InMemoryUserDetailsManager</mark> bean from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityBean</mark> configuration, <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DaoAuthenticationProvider</mark> will automatically use the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DbUserDetailsService</mark> component to load the user by <em>username</em> for authentication. And we can also remove the existing <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">loadAllUserDetails()</mark> method as it is no longer required.</p><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">Please note there is no change in the security restrictions we have applied so far as we have just swapped the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetailsService</mark> implementation from non-persistant datastore to persistant datastore.</p></section></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/db-backed-userdetailsservice" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="permission-evaluator-strategy"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>PermissionEvaluator Strategy</a></span><span class="float-end"><a href="basic-authentication-revisited">Basic Authentication Revisited<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/db-backed-userdetailsservice","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>