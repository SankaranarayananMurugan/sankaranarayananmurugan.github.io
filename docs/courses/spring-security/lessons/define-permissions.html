<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9ec6a016ade6bb0b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9ec6a016ade6bb0b.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/define-permissions-85370baff97e7477.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->11<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/define-permissions" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Define Permissions</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">Let&#x27;s define the permissions for each API in an Enum in the format <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ACTION_RESOURCENAME</mark> as mentioned in the last chapter.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/define-permissions/src/main/java/com/facadecode/spring/security/enums/PermissionEnum.java" target="_blank">PermissionEnum.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PermissionEnum</span> {
    CREATE_COURSE,
    UPDATE_COURSE,
    PLAY_COURSE,
    LIST_STUDENTS,
    LIST_INSTRUCTORS,
    VIEW_PROFILE
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Secure the APIs with Permissions</h3><p class="Paragraph_paragraph__90U8D">We will add the remaining API urls in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityConstants</mark>. We will then apply permission-based access restrictions to the <u>UpdateCourse</u>, <u>PlayCourse</u> and <u>ViewProfile</u> APIs in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration. Let&#x27;s not do any changes in the existing role-based restrictions for now.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/define-permissions/src/main/java/com/facadecode/spring/security/constant/SecurityConstants.java" target="_blank">SecurityConstants.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">API_UPDATE_COURSES</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/api/v1/courses/*&quot;</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">API_PLAY_COURSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/api/v1/courses/play/*&quot;</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">API_VIEW_PROFILE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/api/v1/users/*&quot;</span>;  
</span></code></pre></div><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/define-permissions/src/main/java/com/facadecode/spring/security/config/ApiSecurityConfig.java" target="_blank">ApiSecurityConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">apiFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
    http
        .csrf().disable()
        .authorizeRequests(auth -&gt; auth
            .antMatchers(GET, PUBLIC_API_LIST).permitAll()
            <span class="hljs-comment">// Role based access restrictions</span>
            .antMatchers(API_LIST_STUDENTS, API_LIST_INSTRUCTORS).hasRole(ADMIN.name())
            .antMatchers(POST, API_CREATE_COURSES).hasRole(INSTRUCTOR.name())
            <span class="hljs-comment">// Permission based access restrictions</span>
            .antMatchers(API_UPDATE_COURSES).hasAuthority(UPDATE_COURSE.name())
            .antMatchers(API_PLAY_COURSE).hasAuthority(PLAY_COURSE.name())
            .antMatchers(API_VIEW_PROFILE).hasAuthority(VIEW_PROFILE.name())
            .anyRequest().authenticated()
        )
        .httpBasic();
    <span class="hljs-keyword">return</span> http.build();
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Before applying permission-based restrictions to the above three APIs, we were able to access them once authenticated successfully. But now we will get <em>403 Forbidden</em> error for any user, as we have neither granted these Permissions to any Roles in the database nor updated the authorities in UserDetails.</p></section><section><h3 class="fw-light mt-5 mb-2">AppPermission Entity</h3><p class="Paragraph_paragraph__90U8D">In order to assign permissions dynamically without changing the code, we have to model them as a database entity and establish the relationship with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppRole</mark> entity. As we can assign any number of permissions to any roles, we have to model this as many-to-many relationship with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppRole</mark> entity.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s create an Entity class for Permission and define a standard <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">JPARepository</mark> interface for the entity.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/define-permissions/src/main/java/com/facadecode/spring/security/domain/AppPermission.java" target="_blank">AppPermission.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Entity(name = &quot;app_permission&quot;)</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@EqualsAndHashCode(of = &quot;id&quot;)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppPermission</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Enumerated(value = EnumType.STRING)</span>
    <span class="hljs-keyword">private</span> PermissionEnum name;

    <span class="hljs-meta">@ManyToMany(fetch = FetchType.LAZY, mappedBy = &quot;permissions&quot;)</span>
    <span class="hljs-meta">@JsonIgnore</span>
    <span class="hljs-keyword">private</span> Set&lt;AppRole&gt; assignedRoles;
} 
</span></code></pre></div><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/define-permissions/src/main/java/com/facadecode/spring/security/repo/AppPermissionRepository.java" target="_blank">AppPermissionRepository.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppPermissionRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;AppPermission, Long&gt; {
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Update AppRole Entity</h3><p class="Paragraph_paragraph__90U8D">Now let&#x27;s update the other side of the many-to-many relationship in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppRole</mark> entity, where AppRole entity will be the owner of the relation.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/define-permissions/src/main/java/com/facadecode/spring/security/domain/AppRole.java" target="_blank">AppRole.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-comment">// Other details omitted for brevity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppRole</span> {
    <span class="hljs-meta">@ManyToMany(fetch = FetchType.EAGER)</span>
    <span class="hljs-meta">@JoinTable(
        name = &quot;app_role_to_permission&quot;,
        joinColumns = @JoinColumn(name = &quot;app_role_id&quot;),
        inverseJoinColumns = @JoinColumn(name = &quot;app_permission_id&quot;)
    )</span>
    <span class="hljs-keyword">private</span> Set&lt;AppPermission&gt; permissions;
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Grant Permissions</h3><p class="Paragraph_paragraph__90U8D">The next step after modeling the entity is to create the permission records corresponding to each <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEnum</mark> instances. And then assign them to the roles as mentioned in the below table to align with the Security objectives defined in the first chapter. We can do this in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppDataInitialiser</mark> class in order to make  these changes in the database while bootstraping the application.</p><table class="table table-striped mb-4"><thead><tr><th>Role</th><th>Permissions</th></tr></thead><tbody><tr><td>Student</td><td>PLAY_COURSE, VIEW_PROFILE</td></tr><tr><td>Instructor</td><td>CREATE_COURSE, UPDATE_COURSE, PLAY_COURSE, VIEW_PROFILE</td></tr><tr><td>Admin</td><td>LIST_STUDENTS, LIST_INSTRUCTORS, VIEW_PROFILE</td></tr></tbody></table></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/define-permissions" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="permission-based-authorization"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Permission Based Authorization</a></span><span class="float-end"><a href="assign-permissions">Assign Permissions<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/define-permissions","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>