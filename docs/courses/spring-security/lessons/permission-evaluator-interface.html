<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/01b065b5c84bc69d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/01b065b5c84bc69d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/permission-evaluator-interface-5503852af22e20b2.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->18<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/permission-evaluator-interface" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">PermissionEvaluator Interface</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">We said <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> interface is intended to be the bridge between SpEL and Spring Security&#x27;s ACL system, but it has no hard dependencies to use only ACL module. So we can swap the Spring Security&#x27;s ACL implementation with our own implementation to define ABAC rules.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s implement the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> interface for <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Course</mark> entity and override the two <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> methods. We will find the <em>targetDomainObject</em> inside the method which receives <em>targetId</em> and <em>targetType</em>, and then call the other <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> method which receives the <em>targetDomainObject</em>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/permission-evaluator-interface/src/main/java/com/facadecode/spring/security/security/CoursePermissionEvaluator.java" target="_blank">CoursePermissionEvaluator.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoursePermissionEvaluator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PermissionEvaluator</span> {
    <span class="hljs-comment">// Autowired repositories omitted for brevity</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(Authentication authentication, Object targetDomainObject, Object permission)</span> {
        <span class="hljs-keyword">if</span> (targetDomainObject != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Course</span> <span class="hljs-variable">course</span> <span class="hljs-operator">=</span> (Course) targetDomainObject;
            <span class="hljs-type">PermissionEnum</span> <span class="hljs-variable">permissionEnum</span> <span class="hljs-operator">=</span> PermissionEnum.valueOf((String) permission);

            <span class="hljs-keyword">switch</span>(permissionEnum) {
                <span class="hljs-keyword">case</span> UPDATE_COURSE:
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.isCreatedBy(authentication, course);
                <span class="hljs-keyword">case</span> PLAY_COURSE:
                    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.isEnrolledStudent(authentication, course.getId()) || 
                            <span class="hljs-built_in">this</span>.isCreatedBy(authentication, course);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(Authentication authentication, Serializable targetId, String targetType, Object permission)</span> {
        <span class="hljs-keyword">if</span> (targetId != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Long</span> <span class="hljs-variable">courseId</span> <span class="hljs-operator">=</span> (Long) targetId;
            Optional&lt;Course&gt; course = courseRepository.findById(courseId);
            <span class="hljs-keyword">if</span> (course.isPresent()) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.hasPermission(authentication, course.get(), permission);
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">By this way we can have the authorization check in only one method, but still we can use any of the two <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> expressions based on the availability of either <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">courseId</mark> or <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Course</mark> object defined in the service method signature.</p><p class="Paragraph_paragraph__90U8D">Remember we defined the authorization logic for PLAY_COURSE and UPDATE_COURSE permissions in the previous chapter. We can use them inside <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">CoursePermissionEvaluator</mark> like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/permission-evaluator-interface/src/main/java/com/facadecode/spring/security/security/CoursePermissionEvaluator.java" target="_blank">CoursePermissionEvaluator.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-comment">// PLAY_COURSE permission - Check if the course is enrolled by the authenticated user</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnrolledStudent</span><span class="hljs-params">(Authentication authentication, Long courseId)</span> {
    Optional&lt;AppUser&gt; student = appUserRepository.findByUsername(authentication.getName());
    <span class="hljs-keyword">if</span> (student.isPresent()) {
        <span class="hljs-keyword">return</span> student.get()
                .getEnrolledCourses()
                .stream()
                .anyMatch(course -&gt; course.getId().equals(courseId));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">// UPDATE_COURSE permission - Check if the course is created by the authenticated user</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCreatedBy</span><span class="hljs-params">(Authentication authentication, Course course)</span> {
    <span class="hljs-keyword">return</span> course.getCreatedBy()
            .getUsername()
            .equalsIgnoreCase(authentication.getName());
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Register CoursePermissionEvaluator</h3><p class="Paragraph_paragraph__90U8D">Spring Security will not be aware of our <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> implementation unless we register it with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DefaultMethodSecurityExpressionHandler</mark>. Let&#x27;s do this in a Config class extending <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">GlobalMethodSecurityConfiguration</mark> and overriding it&#x27;s <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">createExpressionHandler()</mark> method. Also it will be more appropriate to move <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@EnableGobalMethodSecurity</mark> to this new <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityConfig</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/permission-evaluator-interface/src/main/java/com/facadecode/spring/security/config/SecurityConfig.java" target="_blank">SecurityConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GlobalMethodSecurityConfiguration</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CoursePermissionEvaluator coursePermissionEvaluator;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> MethodSecurityExpressionHandler <span class="hljs-title function_">createExpressionHandler</span><span class="hljs-params">()</span> {
        <span class="hljs-type">DefaultMethodSecurityExpressionHandler</span> <span class="hljs-variable">defaultMethodSecurityExpressionHandler</span>
                <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMethodSecurityExpressionHandler</span>();
        defaultMethodSecurityExpressionHandler.setPermissionEvaluator(coursePermissionEvaluator);
        <span class="hljs-keyword">return</span> defaultMethodSecurityExpressionHandler;
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Sending a <u>PlayCourse</u> or an <u>UpdateCourse</u> API request will now go through the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">CoursePermissionEvaluator</mark> to perform authorization check before reaching it&#x27;s respective Service method. Let&#x27;s send a <u>PlayCourse</u> API request as Bob who is a Student for one of his enrolled courses, and we will get the course details like below:</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>Authorized request to PlayCourse API as Bob for one of his enrolled courses</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson18-01.png" alt="Authorized request to PlayCourse API as Bob for one of his enrolled courses"/></div><p class="Paragraph_paragraph__90U8D">Similarly if we send the same request for any other courses not enrolled by him we can expect to get <em>403 Forbidden</em> error like below:</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>Unauthorized access request as Bob to play one of the coursed not enrolled by him</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson18-02.png" alt="Unauthorized access request as Bob to play one of the coursed not enrolled by him"/></div><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Exercise</h4><p class="Paragraph_paragraph__90U8D">Remember we have an authorization check <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">isInstructor()</mark> implemented in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ServiceSecurity</mark> for <u>ViewProfile</u> service. In order to be consistent I encourage you to create another <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> implementation for <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> entity and move the authorization check to here. We need to change the SpEL expression from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasAuthority()</mark> to <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasPermission()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authority</mark> constants class for VIEW_PROFILE permission. And we can remove <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ServiceSecurity</mark> class as we no longer need to dump all sorts of authorization checks there.</p><p class="Paragraph_paragraph__90U8D">We know that Spring Security will not be aware of the new <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUserPermissionEvaluator</mark> unless we register it. But we can register only one implementation with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">DefaultMethodSecurityExpressionHandler</mark>. Let&#x27;s see how we can use multiple <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">PermissionEvaluator</mark> implementations in the next chapter.</p></section></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/permission-evaluator-interface" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="domain-object-instance-security"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Domain Object Instance Security</a></span><span class="float-end"><a href="permission-evaluator-strategy">PermissionEvaluator Strategy<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/permission-evaluator-interface","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>