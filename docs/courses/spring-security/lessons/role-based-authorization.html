<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/51d91c5f590b868f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/51d91c5f590b868f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-3fc813d5b2b35cef.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-395f7d23cac5ec2e.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/role-based-authorization-09c70c7d3c4c0c05.js" defer=""></script><script src="/_next/static/QcPToEk8jGA_qcC-TjE0b/_buildManifest.js" defer=""></script><script src="/_next/static/QcPToEk8jGA_qcC-TjE0b/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->7<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/role-based-authorization" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Role Based Authorization</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">So far we are allowed to access any APIs once authenticated successfully. But there are APIs which are supposed to be accessed only by users having specific roles. In the last two chapters, we accessed one of the ADMIN APIs - <u>ListStudents</u> - using Bob who does not have ADMIN role. In this chapter we will fix it by applying role-based authorization to secure the below APIs.</p><table class="table table-striped mb-4"><thead><tr><th>API</th><th>Authorization</th></tr></thead><tbody><tr><td>List Students</td><td>Admin can only view the list of students</td></tr><tr><td>List Instructors</td><td>Admin can only view the list of instructors</td></tr><tr><td>Create Course</td><td>Instructors can only create a new course</td></tr></tbody></table></section><section><h3 class="fw-light mt-5 mb-2">Apply role-based restrictions with hasRole()</h3><p class="Paragraph_paragraph__90U8D">First let&#x27;s add the above API urls in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityConstants</mark> class like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/role-based-authorization/src/main/java/com/facadecode/spring/security/constant/SecurityConstants.java" target="_blank">SecurityConstants.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">API_LIST_STUDENTS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/api/v1/users/students&quot;</span>;  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">API_LIST_INSTRUCTORS</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/api/v1/users/instructors&quot;</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">API_CREATE_COURSES</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/api/v1/courses&quot;</span>;    
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">We can apply customised restrictions to specific urls using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">antMatchers()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpSecurity</mark> configuration. Here we want to apply role-based restrictions which can be achieved using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">hasRole()</mark> with appropriate RoleEnum instance for the above urls as below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/role-based-authorization/src/main/java/com/facadecode/spring/security/config/ApiSecurityConfig.java" target="_blank">ApiSecurityConfig.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiSecurityConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">apiFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http
            .authorizeRequests(auth -&gt; auth
                .antMatchers(GET, PUBLIC_API_LIST).permitAll()
                .antMatchers(API_LIST_STUDENTS, API_LIST_INSTRUCTORS).hasRole(ADMIN.name())
                .antMatchers(POST, API_CREATE_COURSES).hasRole(INSTRUCTOR.name())
                .anyRequest().authenticated()
            )
            .httpBasic();
        <span class="hljs-keyword">return</span> http.build();
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">As <u>ListCourses</u> and <u>CreateCourse</u> endpoints are the same but with different HttpMethod, we have to specify <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">HttpMethod.POST</mark> in the antMatchers for <u>CreateCourse</u> API.</p><p class="Paragraph_paragraph__90U8D">Restart the application and send a GET request to the <u>ListStudents</u> API using Admin user. Though we have secured this API for ADMIN role, we will get <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">403 Forbidden</mark> error. This is because Spring Security has no idea who has the ADMIN role, as we have not yet mapped the roles for any users while creating the list of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> object.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>403 Forbidden error while accessing ListStudents API as ADMIN user</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson07-01.png" alt="403 Forbidden error while accessing ListStudents API as ADMIN user"/></div></section><section><h3 class="fw-light mt-5 mb-2">Update UserDetails with Roles</h3><p class="Paragraph_paragraph__90U8D">We can use <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">roles()</mark> method in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserBuilder</mark> class to map the roles from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark>. It is an overloaded method, here we chose the one which accepts <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">String[]</mark></p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/role-based-authorization/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java" target="_blank">DbUserDetailsService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> List&lt;UserDetails&gt; <span class="hljs-title function_">getAllUserDetails</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> appUserRepository.findAll()
        .stream()
        .map(appUser -&gt; User.builder()
            .username(appUser.getUsername())
            .password(appUser.getPassword())
            .authorities(Collections.EMPTY_SET)
            .roles(<span class="hljs-built_in">this</span>.getRoles(appUser.getRoles()))
            .build()
        )
        .collect(Collectors.toList());
}  

<span class="hljs-keyword">private</span> String[] getRoles(Set&lt;AppRole&gt; roles) {  
    <span class="hljs-keyword">return</span> roles.stream()
        .map(role -&gt; role.getName().name())
        .collect(Collectors.toSet())
        .toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);
}    
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">If we access the <u>ListStudents</u> API using Admin user after restarting the application, we can see the list of students as response. But if we access the same API using Bob who does not have ADMIN role, we will get <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">403 Forbidden</mark> error now.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>List of students for ADMIN user after mapping Roles</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson07-02.png" alt="List of students for ADMIN user after mapping Roles"/></div><div class="p-3"><div class="mb-3 text-secondary text-center"><em>403 Forbidden for users other then ADMIN after mapping Roles</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson07-03.png" alt="403 Forbidden for users other then ADMIN after mapping Roles"/></div></section><section class="px-3 pt-1 my-5 Notes_notes__up3CK"><h4 class="mb-3"><i class="bi bi-info-circle me-2"></i>Note</h4><p class="Paragraph_paragraph__90U8D">Both <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/User.UserBuilder.html#roles%28java.lang.String...%29" target="_blank" class="text-decoration-none"><i class="bi bi-file-text ArticleLink_linkIcon__cf7b_"></i><span class="ArticleLink_linkText__b7K5H">roles()</span></a> and <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/User.UserBuilder.html#authorities%28java.lang.String...%29" target="_blank" class="text-decoration-none"><i class="bi bi-file-text ArticleLink_linkIcon__cf7b_"></i><span class="ArticleLink_linkText__b7K5H">authorities()</span></a> populates the authorities in <a href="https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/User.html" target="_blank" class="text-decoration-none"><i class="bi bi-file-text ArticleLink_linkIcon__cf7b_"></i><span class="ArticleLink_linkText__b7K5H">User</span></a> class, as it has no specific attribute to hold the roles information. But roles() automatically prefixes each entry with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ROLE_</mark>. This means  <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">builder.roles(&quot;ADMIN&quot;)</mark> is equivalent to <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">builder.authorities(&quot;ROLE_ADMIN&quot;)</mark>.</p><p class="Paragraph_paragraph__90U8D">Therefore we should never call them both on <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserBuilder</mark> because the latter will always override the authorities set by the former. Here we are intentionally calling roles() after authorities() in order to override the Collections.EMPTY_SET.</p><p class="Paragraph_paragraph__90U8D">There will be scenarios where you would want to set both roles and authorities. In such cases it is always preferable to pass the roles as argument to authorities() method, where each role must be explicitly prefixed with <strong>ROLE_</strong> by yourself. We will see this in action in the upcoming chapters.</p></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/role-based-authorization" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="permit-public-apis"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Permit Public APIs</a></span><span class="float-end"><a href="disable-csrf">Disable CSRF<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="/courses/spring-security">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/role-based-authorization","query":{},"buildId":"QcPToEk8jGA_qcC-TjE0b","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>