<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/9ec6a016ade6bb0b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9ec6a016ade6bb0b.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/post-authorize-9bb9740c2fa34557.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->15<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/post-authorize" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">PostAuthorize</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D"><mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PostAuthorize</mark> does the same job as <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PreAuthorize</mark>, but does it after the execution of the annotated service method. In doing so we get access to the return value of the method which can be used to make authorization decision inside <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PostAuthorize</mark>. But there is a caveat that any operation which changes the state of the application must be avoided.</p></section><section><h3 class="fw-light mt-5 mb-2">Secure view profile service</h3><p class="Paragraph_paragraph__90U8D">Though we have secured the below service method with <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">VIEW_PROFILE</mark> permission, any authenticated user can view other user&#x27;s profile because this permission is assigned to all the Roles.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/post-authorize/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@PreAuthorize(Authority.VIEW_PROFILE)</span>
<span class="hljs-keyword">public</span> AppUser <span class="hljs-title function_">get</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-keyword">return</span> appUserRepository.findById(userId)
            .orElse(<span class="hljs-literal">null</span>);
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">In order to secure this service method we need to ensure that the authenticated user and the requested user profile are same.</p><p class="Paragraph_paragraph__90U8D">We can get the authenticated user&#x27;s <em>username</em> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContextHolder</mark>. And Spring Security provides an in-built expression to access this <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object using SpEL expression <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">authentication</mark> before the execution of the method.</p><p class="Paragraph_paragraph__90U8D">But unless we find the requested user profile from the repository and confirm that it is same as the authenticated user we can&#x27;t authorize. <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PostAuthorize</mark> allows us to access this requested user profile from the return value using SpEL expression <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">returnObject</mark> after the execution of the method.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/post-authorize/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@PreAuthorize(Authority.VIEW_PROFILE)</span>
<span class="hljs-meta">@PostAuthorize(&quot;returnObject.username == authentication.name&quot;)</span>
<span class="hljs-keyword">public</span> AppUser <span class="hljs-title function_">get</span><span class="hljs-params">(Long userId)</span> {
    <span class="hljs-keyword">return</span> appUserRepository.findById(userId)
            .orElse(<span class="hljs-literal">null</span>);
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Here <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">returnObject</mark> represents the return value of the method which is <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> object. We are checking <em>username</em> of the requested <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> object is equal to the <em>name</em> of the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object after the execution of the method.</p><p class="Paragraph_paragraph__90U8D">Above service returns the AppUser object only for authorized requests post execution, but throws <em>403 Forbidden</em> error for unauthorized requests. Though the service executes all the time, it doesn&#x27;t change the state of the application.</p></section><section><h3 class="fw-light mt-5 mb-2">Test view profile</h3><p class="Paragraph_paragraph__90U8D">Now restart the application, send a GET request to <u>ViewProfile</u> API using <em>Gru</em> to view his own profile and we will be authorized to view his profile.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>Authorized request to view Gru profile with Gru&#x27;s credential</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson15-01.png" alt="Authorized request to view Gru profile with Gru&#x27;s credential"/></div><p class="Paragraph_paragraph__90U8D">But we will get <em>403 Forbidden</em> error if we send the same request to view Gru&#x27;s user profile using any other user credentials.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>Unauthorized request to view Gru profile with Bob&#x27;s credential</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson15-02.png" alt="Unauthorized request to view Gru profile with Bob&#x27;s credential"/></div></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/post-authorize" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="pre-authorize"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>PreAuthorize</a></span><span class="float-end"><a href="authorize-using-spring-beans">Authorize Using Spring Beans<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/post-authorize","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>