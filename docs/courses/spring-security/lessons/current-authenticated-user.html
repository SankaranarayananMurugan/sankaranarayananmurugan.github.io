<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/docs/_next/static/css/0c874e94efaf383b.css" as="style"/><link rel="stylesheet" href="/docs/_next/static/css/0c874e94efaf383b.css" data-n-g=""/><link rel="preload" href="/docs/_next/static/css/9ec6a016ade6bb0b.css" as="style"/><link rel="stylesheet" href="/docs/_next/static/css/9ec6a016ade6bb0b.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/docs/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/docs/_next/static/chunks/webpack-27ee0ced116295fe.js" defer=""></script><script src="/docs/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/docs/_next/static/chunks/main-0793177ecd985022.js" defer=""></script><script src="/docs/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/docs/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/docs/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/docs/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/docs/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/docs/_next/static/chunks/pages/courses/spring-security/lessons/current-authenticated-user-f66a53b8d19bdbbc.js" defer=""></script><script src="/docs/_next/static/m-JwyNEinOpRwABP329Yy/_buildManifest.js" defer=""></script><script src="/docs/_next/static/m-JwyNEinOpRwABP329Yy/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->9<!-- --> of <!-- -->28</div><div class="float-end"><a href="/docs/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/current-authenticated-user" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Current Authenticated User</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">In the last chapter, you might have noticed the value for <em>createdBy</em> field is <em>null</em> in the newly created Course object. Of course, we did not send the user details in the request body for the <em>createdBy</em> field. As every request is authenticated, it makes sense to expect the requestor (Gru) details to get mapped automatically in the <em>createdBy</em> field.</p></section><section><h3 class="fw-light mt-5 mb-2">SecurityContextHolder</h3><p class="Paragraph_paragraph__90U8D">At the heart of Spring Security&#x27;s authentication model is <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContextHolder</mark>. It contains <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark> holding the details of who is authenticated in the form of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object. It uses <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">ThreadLocal</mark> to store these details to make it available for all the methods in the same thread through out the request.</p></section><section><h3 class="fw-light mt-5 mb-2">Authentication</h3><p class="Paragraph_paragraph__90U8D">Authentication represents the token for an authentication request or for an authenticated principal. Technically it serves as the input and output for the one and only <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">authenticate()</mark> method in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationManager</mark> interface.</p><div class="border rounded fs-6 my-4"><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> {
    Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span>
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">As an authentication request it carries the <em>username</em> and <em>password</em> provided by the user where the <em>isAuthenticated</em> flag is set to false by default. Once the request has been processed by the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationManager</mark> it returns back the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as authenticated principal. As an authenticated principal it carries either the username or <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserDetails</mark> and the collection of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">GrantedAuthority</mark> of the authenticated user where the <em>isAuthenticated</em> flag is set to true.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s create a Facade component to get this <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object as an authenticated principal from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContextHolder</mark>.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/current-authenticated-user/src/main/java/com/facadecode/spring/security/security/AuthenticationFacade.java" target="_blank">AuthenticationFacade.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationFacade</span> {
    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">getAuthentication</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> SecurityContextHolder.getContext().getAuthentication();
    }
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Find AppUser using Authentication object</h3><p class="Paragraph_paragraph__90U8D">As the variable type of <em>createdBy</em> field in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Course</mark> entity is <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark>, we have to retrieve the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record from the database using the username found in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s define <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">findByUsername()</mark> method in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUserRepository</mark> interface.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/current-authenticated-user/src/main/java/com/facadecode/spring/security/repo/AppUserRepository.java" target="_blank">AppUserRepository.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppUserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;AppUser, Long&gt; {
    Optional&lt;AppUser&gt; <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Add a service method in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark> to get the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> object by <em>username</em> using the above method.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/current-authenticated-user/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> AppUser <span class="hljs-title function_">get</span><span class="hljs-params">(String username)</span> {
    <span class="hljs-keyword">return</span> appUserRepository.findByUsername(username)
            .orElse(<span class="hljs-literal">null</span>);
}
</span></code></pre></div></section><section><h3 class="fw-light mt-5 mb-2">Create course service</h3><p class="Paragraph_paragraph__90U8D">Now let&#x27;s wire all the above pieces together in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">create()</mark> service method defined in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">CourseService</mark> component, in order to update the <em>createdBy</em> field with the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> object before saving the new Course.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/current-authenticated-user/src/main/java/com/facadecode/spring/security/service/CourseService.java" target="_blank">CourseService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> Course <span class="hljs-title function_">create</span><span class="hljs-params">(Course newCourse)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> authenticationFacade.getAuthentication().getName();
    <span class="hljs-type">AppUser</span> <span class="hljs-variable">currentUser</span> <span class="hljs-operator">=</span> userService.get(username);
    newCourse.setCreatedBy(currentUser);
    <span class="hljs-keyword">return</span> courseRepo.save(newCourse);
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Restart the application and send a POST request to <u>CreateCourse</u> API as Gru who has INSTRUCTOR role. And you can see the <em>createdBy</em> field automatically saved with the requestor details even though we have not sent it as part of the request body.</p><div class="p-3"><div class="mb-3 text-secondary text-center"><em>Newly created course with createdBy field having the requestor details</em></div><img class="img-fluid rounded border shadow" src="/assets/images/spring-security/lesson09-01.png" alt="Newly created course with createdBy field having the requestor details"/></div></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/current-authenticated-user" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="disable-csrf"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Disable CSRF</a></span><span class="float-end"><a href="permission-based-authorization">Permission Based Authorization<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/current-authenticated-user","query":{},"buildId":"m-JwyNEinOpRwABP329Yy","assetPrefix":"/docs","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>