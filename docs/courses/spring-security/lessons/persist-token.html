<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/_next/static/css/ff92f81931bd1587.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ff92f81931bd1587.css" data-n-g=""/><link rel="preload" href="/_next/static/css/acb8172d7678da98.css" as="style"/><link rel="stylesheet" href="/_next/static/css/acb8172d7678da98.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-534f50ab9154eb69.js" defer=""></script><script src="/_next/static/chunks/framework-ae4f43955bfa5ddc.js" defer=""></script><script src="/_next/static/chunks/main-3cf1b4d0a841b0b4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-32643fc599d68fc0.js" defer=""></script><script src="/_next/static/chunks/116-e8f82ba66f2c41a9.js" defer=""></script><script src="/_next/static/chunks/891-9e24b7718d5823e8.js" defer=""></script><script src="/_next/static/chunks/637-6dfba56d742f678a.js" defer=""></script><script src="/_next/static/chunks/462-29b379b3475d5b09.js" defer=""></script><script src="/_next/static/chunks/pages/courses/spring-security/lessons/persist-token-570df6d6dcb68768.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_buildManifest.js" defer=""></script><script src="/_next/static/AKH-6cpO_lfOqlDA3-gc2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><header class="header_header___GOuZ sticky-top"><div class="container"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div></header><main class="my-3"><div class="container"><section class="header_lessonHeader__jhqot"><div class="float-start">Lesson <!-- -->23<!-- --> of <!-- -->28</div><div class="float-end"><a href="/courses/spring-security">Spring Security</a></div></section><div class="clearfix"></div><div class="mt-5"><div class="float-end"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/persist-token" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><section><h1 class="display-5 mt-2 mb-2">Persist Token</h1><p class="Heading_underline__sSwtx"></p><p class="Paragraph_paragraph__90U8D">As we mentioned in the last chapter we have to associate the generated token with the user by storing it in database to make it available for verification on subsequent requests. We will store these tokens along with the user record in the database.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s modify our <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> entity to store the token and it&#x27;s expiry time like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/persist-token/src/main/java/com/facadecode/spring/security/domain/AppUser.java" target="_blank">AppUser.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppUser</span> {
    <span class="hljs-comment">// Other fields omitted for brevity</span>

    <span class="hljs-keyword">private</span> String token;

    <span class="hljs-keyword">private</span> Date tokenExpiryTime;
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Our next step is to identify the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AppUser</mark> record by <em>username</em> and update it with the generated token and it&#x27;s expiry time. We will do this in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark> component by implementing below <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> method.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/persist-token/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateToken</span><span class="hljs-params">(String username, String token, Date tokenExpiryTime)</span> {
    <span class="hljs-type">AppUser</span> <span class="hljs-variable">appUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.get(username);
    appUser.setToken(token);
    appUser.setTokenExpiryTime(tokenExpiryTime);
    appUserRepository.save(appUser);
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Now we can call the above method from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark> immediately after generating the token on successful authentication.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/persist-token/src/main/java/com/facadecode/spring/security/service/AuthenticationService.java" target="_blank">AuthenticationService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">if</span> (authentication.isAuthenticated()) {
    token = UUID.randomUUID().toString();
    userService.updateToken(authentication.getName(), token, <span class="hljs-built_in">this</span>.getTokenExpiryTime());
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Restart the application to automatically update the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">APP_USER</mark> table with the newly added two columns. Test the <u>GenerateToken</u> API to see the generated token persisted for the given user in the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">APP_USER</mark> table.</p></section><section><h3 class="fw-light mt-5 mb-2">Secure update token service</h3><p class="Paragraph_paragraph__90U8D">Are we done with persisting the token? Not Completely. We should never let anyone call the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark> anonymously. We have to secure every service method as part of Service Layer Security. In this case we want only the user who requested the token to update his record with the generated token.</p><p class="Paragraph_paragraph__90U8D">Let&#x27;s define the below condition as a constant in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authority</mark> class, where <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">#username</mark> represents one of the arguments with the same name defined in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> method, and <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">authentication</mark> represents the current authenticated user provided by Spring Security from SecurityContext.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/persist-token/src/main/java/com/facadecode/spring/security/constant/SecurityConstants.java" target="_blank">Authority.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">UPDATE_TOKEN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;#username == authentication.name&quot;</span>;
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Let&#x27;s add the above condition to be evaluated before the execution of <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">@PreAuthroize</mark> annotation.</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/persist-token/src/main/java/com/facadecode/spring/security/service/UserService.java" target="_blank">UserService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@PreAuthorize(Authority.UPDATE_TOKEN)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateToken</span><span class="hljs-params">(String username, String token, Date tokenExpiryTime)</span> {
    <span class="hljs-comment">// Details omitted for brevity</span>
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">As we are authenticating the user using <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationManager</mark> by ourselves, <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark> will not be aware of the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object returned by the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">authenticate()</mark> method. Unlike Basic Auth, where everything was done out of the box by Spring Security for us, here we have to explicitly set the authenticated <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark>.</p></section><section><h3 class="fw-light mt-5 mb-2">Set authentication in SecurityContext</h3><p class="Paragraph_paragraph__90U8D">Let&#x27;s define another method in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationFacade</mark> to set the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">SecurityContext</mark> with the authenticated <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">Authentication</mark> object</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/persist-token/src/main/java/com/facadecode/spring/security/security/AuthenticationFacade.java" target="_blank">AuthenticationFacade.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationFacade</span> {
    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">getAuthentication</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> SecurityContextHolder.getContext().getAuthentication();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthentication</span><span class="hljs-params">(Authentication authentication)</span> {
        SecurityContextHolder.getContext().setAuthentication(authentication);
    }
}
</span></code></pre></div><p class="Paragraph_paragraph__90U8D">Lastly we will call the above <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">setAuthentication()</mark> from <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">AuthenticationService</mark> immediately before calling the <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">updateToken()</mark> in <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">UserService</mark>. The final <mark class="font-monospace border rounded p-1 Mark_mark__8gh_T">generateToken()</mark> thus looks like below:</p><div class="border rounded fs-6 my-4"><div class="p-3 bg-light border-bottom"><span class="font-monospace"><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/blob/persist-token/src/main/java/com/facadecode/spring/security/service/AuthenticationService.java" target="_blank">AuthenticationService.java</a></span><span class="float-end cursor-pointer" data-bs-toggle="tooltip" title="Copy to clipboard"><i class="bi-clipboard"></i></span></div><pre class="m-0 px-3 pb-3"><code class="language-java"><span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String username, String password)</span> {
    <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> UsernamePasswordAuthenticationToken.unauthenticated(username, password);
    authentication = authenticationManager.authenticate(authentication);

    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (authentication.isAuthenticated()) {        
        token = UUID.randomUUID().toString();
        authenticationFacade.setAuthentication(authentication);
        userService.updateToken(authentication.getName(), token, <span class="hljs-built_in">this</span>.getTokenExpiryTime());
    }

    <span class="hljs-keyword">return</span> token;
}

<span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getTokenExpiryTime</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Calendar</span> <span class="hljs-variable">calendar</span> <span class="hljs-operator">=</span> Calendar.getInstance();
    calendar.setTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
    calendar.add(Calendar.MINUTE, <span class="hljs-number">30</span>);
    <span class="hljs-keyword">return</span> calendar.getTime();
}
</span></code></pre></div></section><div class="mt-5"><div class="float-end text-secondary"><a href="#" target="_blank" class="icon-link"><i class="bi-download fs-5 mx-2 cursor-pointer"></i></a><a href="https://github.com/SankaranarayananMurugan/spring-security-for-developers/tree/persist-token" target="_blank" class="icon-link"><i class="bi-github fs-5 mx-2 cursor-pointer"></i></a><a href="javascript:void(0)" class="icon-link"><i class="bi-link-45deg fs-5 mx-2 cursor-pointer"></i></a></div><div class="clearfix"></div></div><hr class=""/><section><p class="Paragraph_paragraph__90U8D"><span class="float-start"><a href="generate-token"><i class="bi-arrow-left-short mx-1 align-middle footer_icon__J1tGG"></i>Generate Token</a></span><span class="float-end"><a href="verify-token">Verify Token<i class="bi-arrow-right-short mx-1 align-middle footer_icon__J1tGG"></i></a></span></p><div class="clearfix"></div></section></div></main><footer class="footer_footer__0KXQq"><div class="mt-5 py-5 text-center fw-lighter text-light bg-secondary"><div class="container"><figure><blockquote class="blockquote">I’m not a great programmer; I’m just a good programmer with great habits</blockquote><figcaption class="blockquote-footer text-light">Kent Beck</figcaption></figure></div></div><div class="py-5 bg-dark"><div class="container"><div class="row"><div class="col-9"><div class="logo_logo__RXjG7 text-white py-2"><div class="hstack"><div class="logo_acronym__FiNtE">FC</div><div class="vr"></div><div><div>FACADE</div><div>CODE</div></div></div></div></div><div class="col"><strong>COURSES</strong><ul class="list-unstyled p-0"><li class="my-2"><a href="#">Spring Security</a></li></ul></div></div></div></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/courses/spring-security/lessons/persist-token","query":{},"buildId":"AKH-6cpO_lfOqlDA3-gc2","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>