(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[684],{4285:function(a,b,c){(window.__NEXT_P=window.__NEXT_P||[]).push(["/courses/spring-security/lessons/role-based-authorization",function(){return c(3511)}])},4621:function(c,a,b){"use strict";var d=b(5893);a.Z=function(a){var c=a.src,b=a.title;return(0,d.jsxs)("div",{className:"p-3",children:[(0,d.jsx)("div",{className:"mb-3 text-secondary text-center",children:(0,d.jsx)("em",{children:b})}),(0,d.jsx)("img",{className:"img-fluid rounded border shadow",src:c,alt:b})]})}},3968:function(d,b,a){"use strict";var e=a(5893),c=a(3394),f=a.n(c);b.Z=function(a){var b=a.title,c=a.children;return(0,e.jsxs)("section",{className:"px-3 pt-1 my-5 ".concat(f().notes),children:[(0,e.jsxs)("h4",{className:"mb-3",children:[(0,e.jsx)("i",{className:"bi bi-info-circle me-2"}),void 0===b?"Note":b]}),c]})}},3511:function(f,b,a){"use strict";a.r(b);var g=a(5893),h=a(9963),i=a(130),j=a(7291),k=a(476),l=a(4621),c=a(9827),d=a(9927),e=a(358),m=a(3968);b.default=(0,c.default)(function(b){var a=b.githubPath;return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)("section",{children:[(0,g.jsx)(h.nL,{children:"Role Based Authorization"}),(0,g.jsxs)(i.Z,{children:["So far we are allowed to access any APIs once authenticated successfully. But there are APIs which are supposed to be accessed only by users having specific roles. In the last two chapters, we accessed one of the ADMIN APIs - ",(0,g.jsx)("u",{children:"ListStudents"})," - using Bob who does not have ADMIN role. In this chapter we will fix it by applying role-based authorization to secure the below APIs."]}),(0,g.jsxs)("table",{className:"table table-striped mb-4",children:[(0,g.jsx)("thead",{children:(0,g.jsxs)("tr",{children:[(0,g.jsx)("th",{children:"API"}),(0,g.jsx)("th",{children:"Authorization"})]})}),(0,g.jsxs)("tbody",{children:[(0,g.jsxs)("tr",{children:[(0,g.jsx)("td",{children:"List Students"}),(0,g.jsx)("td",{children:"Admin can only view the list of students"})]}),(0,g.jsxs)("tr",{children:[(0,g.jsx)("td",{children:"List Instructors"}),(0,g.jsx)("td",{children:"Admin can only view the list of instructors"})]}),(0,g.jsxs)("tr",{children:[(0,g.jsx)("td",{children:"Create Course"}),(0,g.jsx)("td",{children:"Instructors can only create a new course"})]})]})]})]}),(0,g.jsxs)("section",{children:[(0,g.jsx)(h.aC,{children:"Apply role-based restrictions with hasRole()"}),(0,g.jsxs)(i.Z,{children:["First let's add the above API urls in the ",(0,g.jsx)(j.Z,{children:"SecurityConstants"})," class like below:"]}),(0,g.jsx)(k.Z,{fileName:"SecurityConstants.java",href:a+"/src/main/java/com/facadecode/spring/security/constant/SecurityConstants.java",children:'\npublic static final String API_LIST_STUDENTS = "/api/v1/users/students";  \npublic static final String API_LIST_INSTRUCTORS = "/api/v1/users/instructors";\npublic static final String API_CREATE_COURSES = "/api/v1/courses";    \n'}),(0,g.jsxs)(i.Z,{children:["We can apply customised restrictions to specific urls using ",(0,g.jsx)(j.Z,{children:"antMatchers()"})," in ",(0,g.jsx)(j.Z,{children:"HttpSecurity"})," configuration. Here we want to apply role-based restrictions which can be achieved using ",(0,g.jsx)(j.Z,{children:"hasRole()"})," with appropriate RoleEnum instance for the above urls as below:"]}),(0,g.jsx)(k.Z,{fileName:"ApiSecurityConfig.java",href:a+"/src/main/java/com/facadecode/spring/security/config/ApiSecurityConfig.java",children:"\n@Configuration\npublic class ApiSecurityConfig {\n    @Bean\n    public SecurityFilterChain apiFilterChain(HttpSecurity http) throws Exception {\n        http\n            .authorizeRequests(auth -> auth\n                .antMatchers(GET, PUBLIC_API_LIST).permitAll()\n                .antMatchers(API_LIST_STUDENTS, API_LIST_INSTRUCTORS).hasRole(ADMIN.name())\n                .antMatchers(POST, API_CREATE_COURSES).hasRole(INSTRUCTOR.name())\n                .anyRequest().authenticated()\n            )\n            .httpBasic();\n        return http.build();\n    }\n}\n"}),(0,g.jsxs)(i.Z,{children:["As ",(0,g.jsx)("u",{children:"ListCourses"})," and ",(0,g.jsx)("u",{children:"CreateCourse"})," endpoints are the same but with different HttpMethod, we have to specify ",(0,g.jsx)(j.Z,{children:"HttpMethod.POST"})," in the antMatchers for ",(0,g.jsx)("u",{children:"CreateCourse"})," API."]}),(0,g.jsxs)(i.Z,{children:["Restart the application and send a GET request to the ",(0,g.jsx)("u",{children:"ListStudents"})," API using Admin user. Though we have secured this API for ADMIN role, we will get ",(0,g.jsx)(j.Z,{children:"403 Forbidden"})," error. This is because Spring Security has no idea who has the ADMIN role, as we have not yet mapped the roles for any users while creating the list of ",(0,g.jsx)(j.Z,{children:"UserDetails"})," object."]}),(0,g.jsx)(l.Z,{src:"/assets/images/spring-security/lesson07-01.png",title:"403 Forbidden error while accessing ListStudents API as ADMIN user"})]}),(0,g.jsxs)("section",{children:[(0,g.jsx)(h.aC,{children:"Update UserDetails with Roles"}),(0,g.jsxs)(i.Z,{children:["We can use ",(0,g.jsx)(j.Z,{children:"roles()"})," method in ",(0,g.jsx)(j.Z,{children:"UserBuilder"})," class to map the roles from ",(0,g.jsx)(j.Z,{children:"AppUser"}),". It is an overloaded method, here we chose the one which accepts ",(0,g.jsx)(j.Z,{children:"String[]"})]}),(0,g.jsx)(k.Z,{fileName:"DbUserDetailsService.java",href:a+"/src/main/java/com/facadecode/spring/security/service/DbUserDetailsService.java",children:"\npublic List<UserDetails> getAllUserDetails() {\n    return appUserRepository.findAll()\n        .stream()\n        .map(appUser -> User.builder()\n            .username(appUser.getUsername())\n            .password(appUser.getPassword())\n            .authorities(Collections.EMPTY_SET)\n            .roles(this.getRoles(appUser.getRoles()))\n            .build()\n        )\n        .collect(Collectors.toList());\n}  \n\nprivate String[] getRoles(Set<AppRole> roles) {  \n    return roles.stream()\n        .map(role -> role.getName().name())\n        .collect(Collectors.toSet())\n        .toArray(new String[0]);\n}    \n"}),(0,g.jsxs)(i.Z,{children:["If we access the ",(0,g.jsx)("u",{children:"ListStudents"})," API using Admin user after restarting the application, we can see the list of students as response. But if we access the same API using Bob who does not have ADMIN role, we will get ",(0,g.jsx)(j.Z,{children:"403 Forbidden"})," error now."]}),(0,g.jsx)(l.Z,{src:"/assets/images/spring-security/lesson07-02.png",title:"List of students for ADMIN user after mapping Roles"}),(0,g.jsx)(l.Z,{src:"/assets/images/spring-security/lesson07-03.png",title:"403 Forbidden for users other then ADMIN after mapping Roles"})]}),(0,g.jsxs)(m.Z,{children:[(0,g.jsxs)(i.Z,{children:["Both ",(0,g.jsx)("a",{href:"https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/User.UserBuilder.html#roles%28java.lang.String...%29",target:"_blank",children:"roles()"})," and ",(0,g.jsx)("a",{href:"https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/User.UserBuilder.html#authorities%28java.lang.String...%29",target:"_blank",children:"authorities()"})," populates the authorities in ",(0,g.jsx)("a",{href:"https://docs.spring.io/spring-security/site/docs/current/api/org/springframework/security/core/userdetails/User.html",target:"_blank",children:"User"})," class, as it has no specific attribute to hold the roles information. But roles() automatically prefixes each entry with ",(0,g.jsx)(j.Z,{children:"ROLE_"}),". This means  ",(0,g.jsx)(j.Z,{children:'builder.roles("ADMIN")'})," is equivalent to ",(0,g.jsx)(j.Z,{children:'builder.authorities("ROLE_ADMIN")'}),"."]}),(0,g.jsxs)(i.Z,{children:["Therefore we should never call them both on ",(0,g.jsx)(j.Z,{children:"UserBuilder"})," because the latter will always override the authorities set by the former. Here we are intentionally calling roles() after authorities() in order to override the Collections.EMPTY_SET."]}),(0,g.jsxs)(i.Z,{children:["There will be scenarios where you would want to set both roles and authorities. In such cases it is always preferable to pass the roles as argument to authorities() method, where each role must be explicitly prefixed with ",(0,g.jsx)("strong",{children:"ROLE_"})," by yourself. We will see this in action in the upcoming chapters."]})]})]})},(0,e.s)(d.Z,"role-based-authorization"))},3394:function(a){a.exports={notes:"Notes_notes__up3CK"}}},function(a){a.O(0,[116,891,637,462,774,888,179],function(){var b;return a(a.s=4285)}),_N_E=a.O()}])